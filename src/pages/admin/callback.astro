---
// filepath: /Users/ashimeetunyi/Desktop/code/kelifax/src/pages/admin/callback.astro
import MainLayout from '../../layouts/MainLayout.astro';
---

<MainLayout title="Admin Authentication - Kelifax">
  <div class="min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
    <div class="sm:mx-auto sm:w-full sm:max-w-md">
      <div class="text-center">
        <h2 class="mt-6 text-3xl font-extrabold text-gray-900">
          Processing Authentication...
        </h2>
        <div class="mt-4">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
        </div>
      </div>
    </div>
  </div>
</MainLayout>

<script>
  import { handleAuthCallback } from '../../utils/admin-auth.js';

  async function processCallback() {
    try {
      console.log('Processing authentication callback...');
      console.log('Current URL:', window.location.href);
      
      const user = await handleAuthCallback();
      console.log('Authentication successful:', user);
      
      // Add a small delay to ensure tokens are stored
      setTimeout(() => {
        console.log('Redirecting to admin dashboard...');
        window.location.href = '/admin/dashboard';
      }, 100);
      
    } catch (error) {
      console.error('Authentication callback error:', error);
      console.error('Error details:', error.message);
      
      // Show more specific error information
      let errorParam = 'auth_failed';
      if (error.message.includes('No state in response')) {
        errorParam = 'invalid_state';
      } else if (error.message.includes('code')) {
        errorParam = 'invalid_code';
      }
      
      // Redirect back to admin login on error
      window.location.href = `/admin?error=${errorParam}`;
    }
  }

  // Process the callback when page loads
  document.addEventListener('DOMContentLoaded', processCallback);
</script>
