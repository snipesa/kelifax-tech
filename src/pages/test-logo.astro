---
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logo Upload Test - Kelifax</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-6">Logo Upload Test</h1>
        
        <!-- Logo Upload Section -->
        <div class="mb-6">
            <label for="logoImage" class="block text-sm font-medium text-gray-700 mb-2">
                Logo Upload <span class="text-red-500">*</span>
            </label>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors">
                <input type="file" id="logoImage" name="logoImage" accept="image/png" class="hidden">
                <div class="cursor-pointer" onclick="document.getElementById('logoImage').click()">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <div class="mt-2">
                        <p class="text-sm text-gray-600">Click to upload logo</p>
                        <p class="text-xs text-gray-500">PNG only, max 2MB</p>
                    </div>
                </div>
            </div>
            <div class="error-message text-red-500 text-sm mt-1 hidden" data-field="logoImage"></div>
        </div>

        <!-- Logo Preview -->
        <div id="logo-preview" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
            <div class="flex items-center space-x-4">
                <img id="logo-preview-image" src="" alt="Logo preview" class="w-16 h-16 object-cover rounded-lg">
                <div class="flex-1">
                    <p id="logo-filename" class="text-sm font-medium text-gray-900"></p>
                    <p id="logo-filesize" class="text-xs text-gray-500"></p>
                </div>
                <button type="button" id="remove-logo" class="text-red-500 hover:text-red-700">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="mt-6">
            <input type="text" id="resourceName" placeholder="Enter resource name (for filename)" class="w-full p-3 border rounded-lg" value="Test Resource">
        </div>

        <div class="mt-6">
            <h3 class="font-medium mb-2">S3 Connection Test:</h3>
            <button onclick="testS3Connection()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Test S3 Connection</button>
            <div id="connection-result" class="mt-2 text-sm"></div>
        </div>

        <div class="mt-6">
            <h3 class="font-medium mb-2">Debug Info:</h3>
            <div id="debug-info" class="text-sm bg-gray-100 p-3 rounded"></div>
        </div>
    </div>

    <script type="module">
        // Debug environment
        const debugInfo = document.getElementById('debug-info');
        debugInfo.innerHTML = `
            <strong>Environment:</strong><br>
            AWS Access Key: ${import.meta.env.PUBLIC_AWS_ACCESS_KEY_ID ? 'Set' : 'Not Set'}<br>
            AWS Secret: ${import.meta.env.PUBLIC_AWS_SECRET_ACCESS_KEY ? 'Set' : 'Not Set'}<br>
            AWS Region: ${import.meta.env.PUBLIC_AWS_REGION || 'Not Set'}<br>
            S3 Bucket: ${import.meta.env.PUBLIC_S3_BUCKET_NAME || 'Not Set'}<br>
            S3 Prefix: ${import.meta.env.PUBLIC_S3_BUCKET_PREFIX || 'Not Set'}
        `;

        // Initialize logo upload
        const logoInput = document.getElementById('logoImage');
        const logoPreview = document.getElementById('logo-preview');
        const logoPreviewImage = document.getElementById('logo-preview-image');
        const logoFilename = document.getElementById('logo-filename');
        const logoFilesize = document.getElementById('logo-filesize');
        const removeLogo = document.getElementById('remove-logo');

        console.log('Elements found:', {
            logoInput: !!logoInput,
            logoPreview: !!logoPreview,
            logoPreviewImage: !!logoPreviewImage,
            logoFilename: !!logoFilename,
            logoFilesize: !!logoFilesize,
            removeLogo: !!removeLogo
        });

        if (logoInput) {
            logoInput.addEventListener('change', async function(e) {
                console.log('File selected:', e.target.files[0]);
                const file = e.target.files[0];
                if (file) {
                    // Validate file
                    if (file.type !== 'image/png') {
                        showFieldError('logoImage', 'Only PNG files are allowed');
                        this.value = '';
                        return;
                    }
                    
                    if (file.size > 2 * 1024 * 1024) {
                        showFieldError('logoImage', 'File size must be less than 2MB');
                        this.value = '';
                        return;
                    }

                    // Show preview first
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        logoPreviewImage.src = e.target.result;
                        logoFilename.textContent = file.name;
                        logoFilesize.textContent = `${(file.size / 1024).toFixed(1)} KB`;
                        logoPreview.classList.remove('hidden');
                        hideFieldError('logoImage');
                    };
                    reader.readAsDataURL(file);

                    // Upload to S3 immediately
                    try {
                        // Show uploading state
                        logoFilesize.textContent = 'Uploading...';
                        logoFilesize.classList.add('text-blue-600');
                        
                        // Get resource name for filename
                        const resourceNameInput = document.getElementById('resourceName');
                        const resourceName = resourceNameInput.value.trim() || `temp_${Date.now()}`;
                        
                        console.log('Importing S3 upload module...');
                        // Import upload functions
                        const { uploadLogoToS3, isS3Configured, mockLogoUpload } = await import('../utils/s3-upload.js');
                        
                        console.log('S3 configured:', isS3Configured());
                        
                        let uploadResult;
                        if (isS3Configured()) {
                            console.log('Using real S3 upload...');
                            uploadResult = await uploadLogoToS3(file, resourceName);
                        } else {
                            console.log('Using mock S3 upload...');
                            uploadResult = await mockLogoUpload(file, resourceName);
                            console.warn('Using mock S3 upload - configure AWS credentials for actual uploads');
                        }
                        
                        console.log('Upload result:', uploadResult);
                        
                        if (uploadResult.success) {
                            // Update UI to show successful upload
                            logoFilesize.textContent = `${(file.size / 1024).toFixed(1)} KB - Uploaded ✓`;
                            logoFilesize.classList.remove('text-blue-600');
                            logoFilesize.classList.add('text-green-600');
                            
                            // Store the uploaded filename for form submission
                            logoInput.dataset.uploadedFilename = uploadResult.filename;
                            logoInput.dataset.uploadedKey = uploadResult.key;
                            
                            console.log('Logo uploaded successfully:', uploadResult);
                        } else {
                            throw new Error(uploadResult.error || 'Upload failed');
                        }
                    } catch (error) {
                        console.error('Logo upload failed:', error);
                        logoFilesize.textContent = `Upload failed: ${error.message}`;
                        logoFilesize.classList.remove('text-blue-600');
                        logoFilesize.classList.add('text-red-600');
                        showFieldError('logoImage', `Upload failed: ${error.message}`);
                    }
                }
            });

            // Handle remove logo
            removeLogo.addEventListener('click', function() {
                logoInput.value = '';
                logoPreview.classList.add('hidden');
                
                // Clear the uploaded file data
                delete logoInput.dataset.uploadedFilename;
                delete logoInput.dataset.uploadedKey;
                
                hideFieldError('logoImage');
                
                console.log('Logo removed from form');
            });
        }

        // S3 Connection Test
        window.testS3Connection = async function() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.innerHTML = '<div class="text-blue-600">Testing S3 connection...</div>';
            
            try {
                const { testS3Connection, isS3Configured } = await import('../utils/s3-upload.js');
                
                if (!isS3Configured()) {
                    resultDiv.innerHTML = '<div class="text-red-600">❌ S3 not configured - check environment variables</div>';
                    return;
                }
                
                const result = await testS3Connection();
                
                if (result.success) {
                    resultDiv.innerHTML = '<div class="text-green-600">✅ S3 connection successful!</div>';
                } else {
                    resultDiv.innerHTML = `<div class="text-red-600">❌ S3 connection failed: ${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="text-red-600">❌ Connection test error: ${error.message}</div>`;
                console.error('S3 connection test error:', error);
            }
        };

        // Utility functions for error handling
        function showFieldError(fieldName, message) {
            const errorElement = document.querySelector(`[data-field="${fieldName}"]`);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
            }
        }

        function hideFieldError(fieldName) {
            const errorElement = document.querySelector(`[data-field="${fieldName}"]`);
            if (errorElement) {
                errorElement.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
